<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Delegate Robot Model — Robotics for Creative Practice - Fall 2020</title>
    <link rel="stylesheet" href="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/haiku.css" type="text/css">
    <link rel="stylesheet" href="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/pygments.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/graphviz.css">
    <link rel="stylesheet" href="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/guide.css" type="text/css">
    <script id="documentation_options" data-url_root="../" src="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/documentation_options.js"></script>
    <script src="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/jquery.js"></script>
    <script src="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/underscore.js"></script>
    <script src="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/doctools.js"></script>
    <script src="Delegate%20Robot%20Model%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/language_data.js"></script>
    <link rel="index" title="Index" href="https://courses.ideate.cmu.edu/16-375/f2020/text/genindex.html">
    <link rel="search" title="Search" href="https://courses.ideate.cmu.edu/16-375/f2020/text/search.html">
    <link rel="next" title="Proxy Robot Model" href="https://courses.ideate.cmu.edu/16-375/f2020/text/simulations/proxy.html">
    <link rel="prev" title="Wobbly Robot Model" href="https://courses.ideate.cmu.edu/16-375/f2020/text/simulations/wobbly.html"> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="https://courses.ideate.cmu.edu/16-375/f2020/text/index.html">
          <span>Robotics for Creative Practice - Fall 2020</span></a></h1>
        <h2 class="heading"><span>Delegate Robot Model</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&nbsp;&nbsp;<a href="https://courses.ideate.cmu.edu/16-375/f2020/text/simulations/wobbly.html">Wobbly Robot Model</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a class="uplink" href="https://courses.ideate.cmu.edu/16-375/f2020/text/index.html">Contents</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a href="https://courses.ideate.cmu.edu/16-375/f2020/text/simulations/proxy.html">Proxy Robot Model</a>&nbsp;&nbsp;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <div class="section" id="delegate-robot-model">
<span id="delegate-model"></span><h1><a class="toc-backref" href="#id2">Delegate Robot Model</a><a class="headerlink" href="#delegate-robot-model" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">delegate</span></code> robot model is a disembodied supervisor robot which manages
communication between the local simulated radio network and a remote <a class="reference external" href="https://en.wikipedia.org/wiki/MQTT">MQTT</a>
server.  The delegate assumes it is a singleton; no more than one delegate robot
should be added to a world.</p>
<p>It uses the supervisor functions to identify proxy robot bodies in the world,
and then uses them to display the position and name of remote robots as reported
via received MQTT messages.</p>
<p>The model appears in the ‘party’ project available as a zip file
<a class="reference external" href="https://courses.ideate.cmu.edu/16-375/f2020/zip/party.zip">party.zip</a>.</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#delegate-robot-model" id="id2">Delegate Robot Model</a></p>
<ul>
<li><p><a class="reference internal" href="#delegate-proto" id="id3">delegate.proto</a></p></li>
<li><p><a class="reference internal" href="#sample-control-code" id="id4">Sample Control Code</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="delegate-proto">
<h2><a class="toc-backref" href="#id3">delegate.proto</a><a class="headerlink" href="#delegate-proto" title="Permalink to this headline">¶</a></h2>
<p>The robot model has been encapsulated in a .proto file for easy reuse.</p>
<div class="highlight-console notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="gp">#</span>VRML_SIM R2020b utf8
<span class="gp">#</span> Disembodied supervisor robot which can communicate between the
<span class="gp">#</span> <span class="nb">local</span> radio network and a remote MQTT server.  It manages
<span class="gp">#</span> the position of <span class="nb">local</span> proxy robots representing remote participants.
<span class="gp">#</span> documentation url: https://courses.ideate.cmu.edu/16-375
<span class="gp">#</span> license: No copyright, <span class="m">2020</span> Garth Zeglin.  This file is explicitly placed in the public domain.
<span class="go">PROTO delegate [</span>
<span class="go">  field SFVec3f    translation  0 0 0</span>
<span class="go">  field SFRotation rotation     0 1 0 0</span>
<span class="go">  field SFString   controller   "disembod"</span>
<span class="go">  field SFString   name         "delegate"</span>
<span class="go">  field SFString   customData   "Wobbly"</span>
<span class="go">]</span>
<span class="go">{</span>
<span class="go">  Robot {</span>
<span class="gp">    #</span> connect properties to user-visible data fields
<span class="go">    translation IS translation</span>
<span class="go">    rotation IS rotation</span>
<span class="go">    controller IS controller</span>
<span class="go">    name IS name</span>
<span class="go">    customData IS customData</span>

<span class="gp">    #</span> <span class="nb">enable</span> supervisor mode so this robot can directly query simulation state
<span class="gp">    #</span> and configure proxy robots
<span class="go">    supervisor TRUE</span>

<span class="go">    children [</span>
<span class="gp">      #</span> add a default radio receiver and transmitter
<span class="go">      Receiver {</span>
<span class="go">      }</span>
<span class="go">      Emitter {</span>
<span class="go">      }</span>
<span class="go">    ]</span>
<span class="go">  }</span>
<span class="go">}</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="sample-control-code">
<h2><a class="toc-backref" href="#id4">Sample Control Code</a><a class="headerlink" href="#sample-control-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-Python notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1"># disembod.py</span>
<span class="c1">#</span>
<span class="c1"># Sample Webots controller file for a disembodied</span>
<span class="c1"># supervisor robot which communicates between the</span>
<span class="c1"># local radio network and a remote MQTT server.</span>

<span class="c1"># No copyright, 2020, Garth Zeglin.  This file is</span>
<span class="c1"># explicitly placed in the public domain.</span>

<span class="c1">################################################################</span>
<span class="c1"># standard Python libraries</span>
<span class="kn">import</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">getpass</span>

<span class="c1"># Import the Paho MQTT client library.</span>
<span class="c1"># documentation: https://www.eclipse.org/paho/clients/python/docs/</span>
<span class="kn">import</span> <span class="nn">paho.mqtt.client</span> <span class="k">as</span> <span class="nn">mqtt</span>

<span class="c1"># Import the Webots simulator API.</span>
<span class="kn">from</span> <span class="nn">controller</span> <span class="kn">import</span> <span class="n">Supervisor</span>

<span class="c1">################################################################</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"disembod.py waking up."</span><span class="p">)</span>

<span class="n">HOST</span>      <span class="o">=</span> <span class="s2">"mqtt.ideate.cmu.edu"</span>  <span class="c1"># IDeATe MQTT server hostname</span>
<span class="n">PORT</span>      <span class="o">=</span> <span class="mi">8885</span>                   <span class="c1"># port of server instance for 16-375</span>
<span class="n">USER</span>      <span class="o">=</span> <span class="s2">"students"</span>             <span class="c1"># Specific login for this server.</span>
<span class="n">PASSWORD</span>  <span class="o">=</span> <span class="s2">"&lt;password&gt;"</span>           <span class="c1"># Specific password for this login.</span>

<span class="c1"># Define the time step in milliseconds between controller updates.</span>
<span class="n">EVENT_LOOP_DT</span> <span class="o">=</span> <span class="mi">200</span>

<span class="c1">################################################################</span>
<span class="k">class</span> <span class="nc">Disembod</span><span class="p">(</span><span class="n">Supervisor</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Disembod</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: controller connected."</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">))</span>

        <span class="c1"># Connect to the radio emitter and receiver.  The radio runs at the same</span>
        <span class="c1"># rate as the event loop as it is the main function of this robot.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getReceiver</span><span class="p">(</span><span class="s1">'receiver'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emitter</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getEmitter</span><span class="p">(</span><span class="s1">'emitter'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">EVENT_LOOP_DT</span><span class="p">)</span>

        <span class="c1"># The custom data field is used to specify the name of the individual robot</span>
        <span class="c1"># whose data is broadcast over MQTT.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">public_robot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCustomData</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span><span class="s2">"_"</span><span class="p">)</span>

        <span class="c1"># Create a subscription to receive all party messages.  This will</span>
        <span class="c1"># include our own transmissions, but these will be filtered after receipt.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="s1">'party/#'</span>                <span class="c1"># message topics to receive</span>

        <span class="c1"># Create a default broadcast topic based on the current username.</span>
        <span class="c1"># Please customize this as needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_topic</span>   <span class="o">=</span> <span class="s1">'party/'</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="c1"># message topic to send</span>

        <span class="c1"># Initialize the MQTT client system</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span> <span class="o">=</span> <span class="n">mqtt</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">on_connect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_connect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">tls_set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">username_pw_set</span><span class="p">(</span><span class="n">USER</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">)</span>

        <span class="c1"># Initialize the list of available proxies.  Each entry is a tuple with</span>
        <span class="c1"># several field objects used to query and set its state.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Initialize the mapping which allocates proxies to incoming robot names.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_for_name</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Locate proxy robots in the scene tree to use for displaying received data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_proxies</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: found </span><span class="si">%d</span><span class="s2"> proxies."</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">)))</span>

        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">find_proxies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Find the proxy robot bodies in the scene tree to use for displaying the</span>
<span class="sd">        position of remote robots.  This assumes the proxies were created using</span>
<span class="sd">        the proto file and have a base type of proxy rather than Robot, i.e.,</span>
<span class="sd">        were not expanded into base nodes."""</span>

        <span class="c1"># fetch the root node of the scene tree, a Group object containing all visible nodes</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRoot</span><span class="p">()</span>
        <span class="n">top_level</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">getField</span><span class="p">(</span><span class="s1">'children'</span><span class="p">)</span>
        <span class="n">num_items</span> <span class="o">=</span> <span class="n">top_level</span><span class="o">.</span><span class="n">getCount</span><span class="p">()</span>

        <span class="c1"># walk the list of top-level scene tree nodes to look for proxy objects</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_items</span><span class="p">):</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">top_level</span><span class="o">.</span><span class="n">getMFNode</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">basetype</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getBaseTypeName</span><span class="p">()</span>
            <span class="n">typename</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getTypeName</span><span class="p">()</span>
            <span class="c1"># print("Found base type", basetype)</span>
            <span class="k">if</span> <span class="n">basetype</span> <span class="o">==</span> <span class="s1">'Robot'</span> <span class="ow">and</span> <span class="n">typename</span> <span class="o">==</span> <span class="s1">'proxy'</span><span class="p">:</span>
                <span class="n">name_field</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getField</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
                <span class="n">pos_field</span>  <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getField</span><span class="p">(</span><span class="s1">'translation'</span><span class="p">)</span>
                <span class="n">rot_field</span>  <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">getField</span><span class="p">(</span><span class="s1">'rotation'</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">name_field</span><span class="p">,</span> <span class="n">pos_field</span><span class="p">,</span> <span class="n">rot_field</span><span class="p">))</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name_field</span><span class="o">.</span><span class="n">getSFString</span><span class="p">()</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">pos_field</span><span class="o">.</span><span class="n">getSFVec3f</span><span class="p">()</span>
                <span class="c1"># print("Found proxy %s at %s" % (name, position))</span>

    <span class="k">def</span> <span class="nf">get_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">"""Return a proxy body for the given robot name.  Either returns an existing</span>
<span class="sd">        proxy, allocates an available one, or returns None if no more are available."""</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_for_name</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">del</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">name_field</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">name_field</span><span class="o">.</span><span class="n">setSFString</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proxy_for_name</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: allocated proxy for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">proxy</span>

    <span class="k">def</span> <span class="nf">set_proxy_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">heading</span><span class="p">):</span>
        <span class="c1"># extract the fields from the proxy list, see find_proxies for format</span>
        <span class="n">pos_field</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">rot_field</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># set the X, Y location</span>
        <span class="n">pos_field</span><span class="o">.</span><span class="n">setSFVec3f</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>

        <span class="c1"># convert the compass heading to an angle in radians w.r.t. the reference pose and apply it to the Z rotation</span>
        <span class="n">radians</span> <span class="o">=</span> <span class="p">(</span><span class="mi">90</span> <span class="o">-</span> <span class="n">heading</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">180.0</span><span class="p">)</span>
        <span class="n">rot_field</span><span class="o">.</span><span class="n">setSFRotation</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">radians</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="c1"># Declare some MQTT callbacks.</span>
    <span class="k">def</span> <span class="nf">on_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">):</span>
        <span class="c1"># Subscribing in on_connect() means that if we lose the connection and reconnect then subscriptions will be renewed.</span>
        <span class="k">global</span> <span class="n">mqtt_client</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: MQTT connected to server with with flags: </span><span class="si">%s</span><span class="s2">, result code: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rc</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: MQTT subscribing to </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscription</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subscription</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">userdata</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># filter out our own transmissions</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_topic</span><span class="p">:</span>
            <span class="c1"># print("MQTT message received: {%s} %s" % (msg.topic, msg.payload))</span>

            <span class="c1"># the expected topic has the form party/name, this will extract the name</span>
            <span class="n">topic_path</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">topic_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">remote_name</span> <span class="o">=</span> <span class="n">topic_path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proxy</span><span class="p">(</span><span class="n">remote_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">proxy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: no proxy body available for </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if a proxy body is available, parse the message text</span>
                    <span class="n">tokens</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> received malformed message on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">payload</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="c1"># apply the received data to the proxy body</span>
                            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">heading</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">set_proxy_pose</span><span class="p">(</span><span class="n">proxy</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">heading</span><span class="p">)</span>

                            <span class="c1"># and also rebroadcast on the local radio network</span>
                            <span class="c1"># emitter requires a bytestring, not a Python Unicode string</span>
                            <span class="n">data</span> <span class="o">=</span> <span class="n">remote_name</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">" "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">payload</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">emitter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> received malformed message on </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">payload</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Connect to the MQTT network</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: initiating MQTT connection to </span><span class="si">%s</span><span class="s2">:</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">)</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">poll_receiver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Process all available radio messages, forwarding select messages to the MQTT</span>
<span class="sd">           network based on the first message token."""</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">getQueueLength</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">getData</span><span class="p">()</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> malformed packet: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_name</span><span class="p">,</span> <span class="n">packet</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="c1"># convert bytestring to Unicode</span>
                <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">public_robot</span><span class="p">:</span>
                    <span class="c1"># retransmit the remaining message string unchanged over MQTT; this</span>
                    <span class="c1"># will retain some flexibility against message format changes</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">" "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">send_topic</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="c1"># done with packet processing, advance to the next packet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">nextPacket</span><span class="p">()</span>
        <span class="c1"># no more data</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Run loop to execute a periodic script until the simulation quits.</span>
        <span class="c1"># If the controller returns -1, the simulator is quitting.</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">EVENT_LOOP_DT</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Poll the simulated radio receiver.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poll_receiver</span><span class="p">()</span>

            <span class="c1"># Poll the MQTT network system.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

            <span class="c1"># Read simulator clock time.</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getTime</span><span class="p">()</span>

            <span class="c1"># Test: move one proxy</span>


        <span class="c1"># Shut down the networking cleanly.  At this point</span>
        <span class="c1"># print() output will no longer show in the Webots</span>
        <span class="c1"># console, so this is silent.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mqtt_client</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

<span class="c1">################################################################</span>

<span class="n">controller</span> <span class="o">=</span> <span class="n">Disembod</span><span class="p">()</span>
<span class="n">controller</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="n">controller</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&nbsp;&nbsp;<a href="https://courses.ideate.cmu.edu/16-375/f2020/text/simulations/wobbly.html">Wobbly Robot Model</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a class="uplink" href="https://courses.ideate.cmu.edu/16-375/f2020/text/index.html">Contents</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a href="https://courses.ideate.cmu.edu/16-375/f2020/text/simulations/proxy.html">Proxy Robot Model</a>&nbsp;&nbsp;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        © Copyright 2020, Garth Zeglin. Licensed under <a class="reference external" href="http://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>.
      Last updated on 2021-01-26.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.
    <a class="reference external" href="https://www.cmu.edu/legal/">University legal notice</a>.
    </div>
  
</body></html>