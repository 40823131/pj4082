<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <title>Double Pendulum Simulator — Robotics for Creative Practice - Fall 2020</title>
    <link rel="stylesheet" href="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/haiku.css" type="text/css">
    <link rel="stylesheet" href="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/pygments.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/graphviz.css">
    <link rel="stylesheet" href="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/guide.css" type="text/css">
    <script id="documentation_options" data-url_root="../" src="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/documentation_options.js"></script>
    <script src="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/jquery.js"></script>
    <script src="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/underscore.js"></script>
    <script src="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/doctools.js"></script>
    <script src="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/language_data.js"></script>
    <link rel="index" title="Index" href="https://courses.ideate.cmu.edu/16-375/f2020/text/genindex.html">
    <link rel="search" title="Search" href="https://courses.ideate.cmu.edu/16-375/f2020/text/search.html">
    <link rel="next" title="exercise3.py sample code" href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/exercise3.html">
    <link rel="prev" title="MQTT Monitor (PyQt5)" href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/MQTT-Monitor.html"> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="https://courses.ideate.cmu.edu/16-375/f2020/text/index.html">
          <span>Robotics for Creative Practice - Fall 2020</span></a></h1>
        <h2 class="heading"><span>Double Pendulum Simulator</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&nbsp;&nbsp;<a href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/MQTT-Monitor.html">MQTT Monitor (PyQt5)</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a class="uplink" href="https://courses.ideate.cmu.edu/16-375/f2020/text/index.html">Contents</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/exercise3.html">exercise3.py sample code</a>&nbsp;&nbsp;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <a class="reference internal image-reference" href="https://courses.ideate.cmu.edu/16-375/f2020/text/_images/dblpend-swingup-screenshot.png"><img alt="../_images/dblpend-swingup-screenshot.png" class="align-center" src="Double%20Pendulum%20Simulator%20%E2%80%94%20Robotics%20for%20Creative%20Practice%20-%20Fall%202020_files/dblpend-swingup-screenshot.png" style="width: 50%;"></a>
<div class="section" id="double-pendulum-simulator">
<span id="double-pendulum-simulation"></span><h1><a class="toc-backref" href="#id2">Double Pendulum Simulator</a><a class="headerlink" href="#double-pendulum-simulator" title="Permalink to this headline">¶</a></h1>
<p>The double pendulum simulator demonstrates the dynamic simulation and control of
a two-link arm.  Without joint torques, it is a chaotic double-pendulum system,
but with control torques applied, it is a limitless two-link arm in a vertical
plane.</p>
<p>The simulator is written in Python 3 using PyQt5 for the user interface.  Each
exercise has specific demo code and the library packaged as a single file:</p>
<blockquote>
<div><div class="line-block">
<div class="line"><a class="reference external" href="https://courses.ideate.cmu.edu/16-375/f2020/zip/exercise1.zip">exercise1.zip</a></div>
<div class="line"><a class="reference external" href="https://courses.ideate.cmu.edu/16-375/f2020/zip/exercise2.zip">exercise2.zip</a></div>
</div>
</div></blockquote>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#double-pendulum-simulator" id="id2">Double Pendulum Simulator</a></p>
<ul>
<li><p><a class="reference internal" href="#requirements" id="id3">Requirements</a></p></li>
<li><p><a class="reference internal" href="#script-examples" id="id4">Script Examples</a></p>
<ul>
<li><p><a class="reference internal" href="#free-motion-script" id="id5">Free Motion Script</a></p></li>
<li><p><a class="reference internal" href="#keyframed-motion-demo-script" id="id6">Keyframed Motion Demo Script</a></p></li>
<li><p><a class="reference internal" href="#swing-up-demo-script" id="id7">Swing-up Demo Script</a></p></li>
<li><p><a class="reference internal" href="#dual-robot-free-swing" id="id8">Dual-Robot Free Swing</a></p></li>
<li><p><a class="reference internal" href="#dual-robot-spirals" id="id9">Dual-Robot Spirals</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="requirements">
<h2><a class="toc-backref" href="#id3">Requirements</a><a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The code requires a working installation of Python 3 with PyQt5, scipy, numpy, and pyqtgraph.
On an IDeATe cluster MacBook Pro, you will need to use the specific installation
of Python 3 which includes the required libraries.  The simulator scripts can be run
from the Terminal command line on an IDeATe cluster MBP as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span> <span class="n">dblpend_free</span><span class="o">.</span><span class="n">py</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span> <span class="n">dblpend_keyframes</span><span class="o">.</span><span class="n">py</span>
<span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">python3</span><span class="o">.</span><span class="mi">5</span> <span class="n">dblpend_swingup</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>A README.txt file is included in the zip with more detailed launching instructions.</p>
</div>
<div class="section" id="script-examples">
<h2><a class="toc-backref" href="#id4">Script Examples</a><a class="headerlink" href="#script-examples" title="Permalink to this headline">¶</a></h2>
<p>The simulator library module <a class="reference internal" href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/rcp/ex/dblpend.html#module-rcp.ex.dblpend" title="rcp.ex.dblpend"><code class="xref py py-mod docutils literal notranslate"><span class="pre">rcp.ex.dblpend</span></code></a> provides a common GUI
framework with a graphic cartoon, phase plot, text display, and general-purpose
parameter sliders.  The top-level scripts all share this module but add a
specific control function to execute a movement.  Following are several sample
scripts highlighting different approaches.  The underlying numerical code can be
found in <a class="reference internal" href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/rcp/doublependulum.html#module-rcp.doublependulum" title="rcp.doublependulum"><code class="xref py py-mod docutils literal notranslate"><span class="pre">rcp.doublependulum</span></code></a>.</p>
<div class="section" id="free-motion-script">
<h3><a class="toc-backref" href="#id5">Free Motion Script</a><a class="headerlink" href="#free-motion-script" title="Permalink to this headline">¶</a></h3>
<p>The ‘free motion’ demo applies zero torques to show the natural dynamics of a
chaotic double pendulum.  The script subclasses
<a class="reference internal" href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/rcp/doublependulum.html#rcp.doublependulum.DoublePendulumController" title="rcp.doublependulum.DoublePendulumController"><code class="xref py py-class docutils literal notranslate"><span class="pre">rcp.doublependulum.DoublePendulumController</span></code></a> to provide a custom
control method, then passes the class itself into the application framework.</p>
<div class="highlight-Python notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""Prototype Python 3 script for the 16-375 double-pendulum control exercise."""</span>

<span class="c1">################################################################</span>
<span class="c1"># Written in 2018-2019 by Garth Zeglin &lt;garthz@cmu.edu&gt;</span>

<span class="c1"># To the extent possible under law, the author has dedicated all copyright</span>
<span class="c1"># and related and neighboring rights to this software to the public domain</span>
<span class="c1"># worldwide. This software is distributed without any warranty.</span>

<span class="c1"># You should have received a copy of the CC0 Public Domain Dedication along with this software.</span>
<span class="c1"># If not, see &lt;http://creativecommons.org/publicdomain/zero/1.0/&gt;.</span>

<span class="c1">################################################################</span>

<span class="kn">import</span> <span class="nn">rcp.doublependulum</span>
<span class="kn">from</span> <span class="nn">rcp.ex.dblpend</span> <span class="kn">import</span> <span class="n">main</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">################################################################</span>
<span class="k">class</span> <span class="nc">PendulumController</span><span class="p">(</span><span class="n">rcp</span><span class="o">.</span><span class="n">doublependulum</span><span class="o">.</span><span class="n">DoublePendulumController</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># override the default initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""Passive double-pendulum simulation.</span>
<span class="s2">A zero torque vector is applied to the joints so they swing freely.  The underlying simulation has frictionless joints so the behavior is chaotic. It is ultimately unstable due to accumulated numerical error.</span><span class="se">\n</span><span class="s2">"""</span><span class="p">)</span>

        <span class="k">return</span>
            
    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">"""Method called from simulator to calculate the next step of applied torques.</span>

<span class="sd">        :param t: time in seconds since simulation began</span>
<span class="sd">        :param state: four element numpy array with joint positions ``q`` and joint velocities ``qd`` as ``[q0, q1, qd0, qd1]``, expressed in radians and radians/sec</span>
<span class="sd">        :param tau: two element numpy array to fill in with the joint torques to apply ``[tau0, tau1]``</span>
<span class="sd">        """</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># temporary kinematics test</span>
        <span class="c1"># elbow, end = self.model.forwardKinematics(state[0:2])</span>
        <span class="c1"># s1, s2 = self.model.endpointIK(end)</span>
        <span class="c1"># print("q:", state[0], state[1], "elbow:", elbow, "end:", end, "solution1: ", s1, "solution2:", s2)</span>
        <span class="c1"># print("q:", state[0], state[1], "end:", end, "solution1: ", s1, "solution2:", s2)</span>
        
        <span class="k">return</span>

<span class="c1">################################################################$</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">PendulumController</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="keyframed-motion-demo-script">
<h3><a class="toc-backref" href="#id6">Keyframed Motion Demo Script</a><a class="headerlink" href="#keyframed-motion-demo-script" title="Permalink to this headline">¶</a></h3>
<p>The ‘keyframed motion’ demo applies position control using a short looped sequences of reference poses.</p>
<div class="highlight-Python notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""Prototype Python 3 script for the 16-375 double-pendulum control exercise."""</span>

<span class="c1">################################################################</span>
<span class="c1"># Written in 2018-2019 by Garth Zeglin &lt;garthz@cmu.edu&gt;</span>

<span class="c1"># To the extent possible under law, the author has dedicated all copyright</span>
<span class="c1"># and related and neighboring rights to this software to the public domain</span>
<span class="c1"># worldwide. This software is distributed without any warranty.</span>

<span class="c1"># You should have received a copy of the CC0 Public Domain Dedication along with this software.</span>
<span class="c1"># If not, see &lt;http://creativecommons.org/publicdomain/zero/1.0/&gt;.</span>

<span class="c1">################################################################</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">rcp.doublependulum</span>
<span class="kn">from</span> <span class="nn">rcp.ex.dblpend</span> <span class="kn">import</span> <span class="n">main</span>

<span class="c1">################################################################</span>
<span class="k">class</span> <span class="nc">PendulumController</span><span class="p">(</span><span class="n">rcp</span><span class="o">.</span><span class="n">doublependulum</span><span class="o">.</span><span class="n">DoublePendulumController</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># for this example, there are four fixed poses commanded a fixed intervals, expressed as a set of (q0, q1) pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""Keyframed position control demonstration.</span>

<span class="s2">Applies a sequence of joint targets to a position controller at fixed intervals.</span>

<span class="s2">The parameter sliders 0 and 1 control the 'shoulder' and 'elbow' angles for the first keyframe, 2 and 3 are the second keyframe, etc.</span>

<span class="s2">"""</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">user_parameter_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">joint</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">pose</span> <span class="o">&lt;</span>  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">pose</span><span class="p">][</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Set pose </span><span class="si">%d</span><span class="s2"> joint </span><span class="si">%d</span><span class="s2"> to angle </span><span class="si">%f</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">joint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">pose</span><span class="p">][</span><span class="n">joint</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">apply_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">'keyframes'</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)):</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">]</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q0'</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">]</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q1'</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">q0</span><span class="p">,</span> <span class="n">q1</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">gather_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">'keyframes'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)):</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">][</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q0'</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">][</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q1'</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">"""Method called from simulator to calculate the next step of applied torques.</span>

<span class="sd">        :param t: time in seconds since simulation began</span>
<span class="sd">        :param state: four element numpy array with joint positions ``q`` and joint velocities ``qd`` as ``[q0, q1, qd0, qd1]``, expressed in radians and radians/sec</span>
<span class="sd">        :param tau: two element numpy array to fill in with the joint torques to apply ``[tau0, tau1]``</span>
<span class="sd">        """</span>
        <span class="c1"># select the current keyframe based on the time</span>
        <span class="n">frame</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span> <span class="o">//</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Starting frame </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">=</span> <span class="n">frame</span>

        <span class="c1"># select the pose for the current keyframe, looping over the available poses</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">frame</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)]</span>

        <span class="c1"># create a target state by extending the pose to include velocity</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pose</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># calculate position and velocity error as difference from reference state</span>
        <span class="n">qerr</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">state</span>

        <span class="c1"># apply PD control to reach the pose (no integral term)</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span>

<span class="c1">################################################################$</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">PendulumController</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="swing-up-demo-script">
<h3><a class="toc-backref" href="#id7">Swing-up Demo Script</a><a class="headerlink" href="#swing-up-demo-script" title="Permalink to this headline">¶</a></h3>
<p>The ‘swingup’ demo applies position control using a short looped sequences of reference poses.</p>
<div class="highlight-Python notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""Prototype Python 3 script for the 16-375 double-pendulum control exercise."""</span>

<span class="c1">################################################################</span>
<span class="c1"># Written in 2018-2019 by Garth Zeglin &lt;garthz@cmu.edu&gt;</span>

<span class="c1"># To the extent possible under law, the author has dedicated all copyright</span>
<span class="c1"># and related and neighboring rights to this software to the public domain</span>
<span class="c1"># worldwide. This software is distributed without any warranty.</span>

<span class="c1"># You should have received a copy of the CC0 Public Domain Dedication along with this software.</span>
<span class="c1"># If not, see &lt;http://creativecommons.org/publicdomain/zero/1.0/&gt;.</span>

<span class="c1">################################################################</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">rcp.doublependulum</span>
<span class="kn">from</span> <span class="nn">rcp.ex.dblpend</span> <span class="kn">import</span> <span class="n">main</span>

<span class="c1">################################################################</span>
<span class="k">class</span> <span class="nc">PendulumController</span><span class="p">(</span><span class="n">rcp</span><span class="o">.</span><span class="n">doublependulum</span><span class="o">.</span><span class="n">DoublePendulumController</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># for this example, there are four fixed poses commanded a fixed intervals, expressed as a set of (q0, q1) pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""Keyframed position control demonstration.</span>

<span class="s2">Applies a sequence of joint targets to a position controller at fixed intervals.</span>

<span class="s2">The parameter sliders 0 and 1 control the 'shoulder' and 'elbow' angles for the first keyframe, 2 and 3 are the second keyframe, etc.</span>

<span class="s2">"""</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">user_parameter_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">joint</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">pose</span> <span class="o">&lt;</span>  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">pose</span><span class="p">][</span><span class="n">joint</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Set pose </span><span class="si">%d</span><span class="s2"> joint </span><span class="si">%d</span><span class="s2"> to angle </span><span class="si">%f</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">joint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">pose</span><span class="p">][</span><span class="n">joint</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">apply_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">'keyframes'</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)):</span>
                <span class="n">q0</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">]</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q0'</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="n">q1</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">]</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q1'</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">fallback</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">q0</span><span class="p">,</span> <span class="n">q1</span><span class="p">]</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">gather_configuration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">'keyframes'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)):</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">][</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q0'</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">config</span><span class="p">[</span><span class="s1">'keyframes'</span><span class="p">][</span><span class="s1">'keyframe-</span><span class="si">%d</span><span class="s1">-q1'</span> <span class="o">%</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">"""Method called from simulator to calculate the next step of applied torques.</span>

<span class="sd">        :param t: time in seconds since simulation began</span>
<span class="sd">        :param state: four element numpy array with joint positions ``q`` and joint velocities ``qd`` as ``[q0, q1, qd0, qd1]``, expressed in radians and radians/sec</span>
<span class="sd">        :param tau: two element numpy array to fill in with the joint torques to apply ``[tau0, tau1]``</span>
<span class="sd">        """</span>
        <span class="c1"># select the current keyframe based on the time</span>
        <span class="n">frame</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">t</span> <span class="o">//</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Starting frame </span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">frame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_frame</span> <span class="o">=</span> <span class="n">frame</span>

        <span class="c1"># select the pose for the current keyframe, looping over the available poses</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">[</span><span class="n">frame</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframes</span><span class="p">)]</span>

        <span class="c1"># create a target state by extending the pose to include velocity</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pose</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># calculate position and velocity error as difference from reference state</span>
        <span class="n">qerr</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">state</span>

        <span class="c1"># apply PD control to reach the pose (no integral term)</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span>

<span class="c1">################################################################$</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">PendulumController</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="dual-robot-free-swing">
<h3><a class="toc-backref" href="#id8">Dual-Robot Free Swing</a><a class="headerlink" href="#dual-robot-free-swing" title="Permalink to this headline">¶</a></h3>
<p>The two-pendulum ‘free’ demo applies zero torques using a pair of double-pendula to show the natural dynamics
from slightly different initial conditions.</p>
<div class="highlight-Python notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""Prototype Python 3 script for the 16-375 double-pendulum control exercise."""</span>

<span class="c1">################################################################</span>
<span class="c1"># Written in 2018-2019 by Garth Zeglin &lt;garthz@cmu.edu&gt;</span>

<span class="c1"># To the extent possible under law, the author has dedicated all copyright</span>
<span class="c1"># and related and neighboring rights to this software to the public domain</span>
<span class="c1"># worldwide. This software is distributed without any warranty.</span>

<span class="c1"># You should have received a copy of the CC0 Public Domain Dedication along with this software.</span>
<span class="c1"># If not, see &lt;http://creativecommons.org/publicdomain/zero/1.0/&gt;.</span>

<span class="c1">################################################################</span>

<span class="kn">import</span> <span class="nn">rcp.doublependulum</span>
<span class="kn">from</span> <span class="nn">rcp.ex.ndblpend</span> <span class="kn">import</span> <span class="n">main</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1">################################################################</span>
<span class="k">class</span> <span class="nc">PendulumController</span><span class="p">(</span><span class="n">rcp</span><span class="o">.</span><span class="n">doublependulum</span><span class="o">.</span><span class="n">DoublePendulumController</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># override the default initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
        <span class="k">return</span>

    <span class="c1">#================================================================</span>
    <span class="c1"># Specialize this particular controller when a member of an ensemble.</span>
    <span class="k">def</span> <span class="nf">set_identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serial_number</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set_identity</span><span class="p">(</span><span class="n">serial_number</span><span class="p">)</span>
        <span class="c1"># perturb the initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initial_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="k">return</span>
    
    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""Passive double-pendulum simulation.</span>
<span class="s2">A zero torque vector is applied to the joints so they swing freely.  The underlying simulation has frictionless joints so the behavior is chaotic. It is ultimately unstable due to accumulated numerical error.</span><span class="se">\n</span><span class="s2">"""</span><span class="p">)</span>

        <span class="k">return</span>
    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">"""Method called from simulator to calculate the next step of applied torques.</span>

<span class="sd">        :param t: time in seconds since simulation began</span>
<span class="sd">        :param state: four element numpy array with joint positions ``q`` and joint velocities ``qd`` as ``[q0, q1, qd0, qd1]``, expressed in radians and radians/sec</span>
<span class="sd">        :param tau: two element numpy array to fill in with the joint torques to apply ``[tau0, tau1]``</span>
<span class="sd">        """</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># temporary kinematics test</span>
        <span class="c1"># elbow, end = self.model.forwardKinematics(state[0:2])</span>
        <span class="c1"># s1, s2 = self.model.endpointIK(end)</span>
        <span class="c1"># print("q:", state[0], state[1], "elbow:", elbow, "end:", end, "solution1: ", s1, "solution2:", s2)</span>
        <span class="c1"># print("q:", state[0], state[1], "end:", end, "solution1: ", s1, "solution2:", s2)</span>
        
        <span class="k">return</span>

<span class="c1">################################################################$</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">PendulumController</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="dual-robot-spirals">
<h3><a class="toc-backref" href="#id9">Dual-Robot Spirals</a><a class="headerlink" href="#dual-robot-spirals" title="Permalink to this headline">¶</a></h3>
<p>The two-pendulum ‘spirals’ demo uses inverse kinematics to track a 
spiral with the left arm, using the right arm to track the left.</p>
<div class="highlight-Python notranslate"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">"""Prototype Python 3 script for the 16-375 double-pendulum control exercise."""</span>

<span class="c1">################################################################</span>
<span class="c1"># Written in 2018-2019 by Garth Zeglin &lt;garthz@cmu.edu&gt;</span>

<span class="c1"># To the extent possible under law, the author has dedicated all copyright</span>
<span class="c1"># and related and neighboring rights to this software to the public domain</span>
<span class="c1"># worldwide. This software is distributed without any warranty.</span>

<span class="c1"># You should have received a copy of the CC0 Public Domain Dedication along with this software.</span>
<span class="c1"># If not, see &lt;http://creativecommons.org/publicdomain/zero/1.0/&gt;.</span>

<span class="c1">################################################################</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">rcp.doublependulum</span>
<span class="kn">from</span> <span class="nn">rcp.ex.ndblpend</span> <span class="kn">import</span> <span class="n">main</span>

<span class="c1">################################################################</span>
<span class="k">class</span> <span class="nc">PendulumController</span><span class="p">(</span><span class="n">rcp</span><span class="o">.</span><span class="n">doublependulum</span><span class="o">.</span><span class="n">DoublePendulumController</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># set stiffer position and damping gains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kp</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kd</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">16.0</span><span class="p">,</span>  <span class="mf">8.0</span><span class="p">))</span>

        <span class="k">return</span>
    
    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"""Pair of double-pendulum simulations.</span>

<span class="s2">One moves the endpoint along a circular path, while the other tries to follow.</span>
<span class="s2">"""</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1">#================================================================</span>
    <span class="k">def</span> <span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
        <span class="sd">"""Method called from simulator to calculate the next step of applied torques.</span>

<span class="sd">        :param t: time in seconds since simulation began</span>
<span class="sd">        :param state: four element numpy array with joint positions ``q`` and joint velocities ``qd`` as ``[q0, q1, qd0, qd1]``, expressed in radians and radians/sec</span>
<span class="sd">        :param tau: two element numpy array to fill in with the joint torques to apply ``[tau0, tau1]``</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># the first robot chooses a target pose in robot coordinates based</span>
            <span class="c1"># on the inverse kinematics solution for a spiral path</span>

            <span class="c1"># phase cycles one revolution of the circular path angle every 8 seconds</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">t</span>

            <span class="c1"># radius slowly cycles up and down again</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">t</span><span class="p">))</span>

            <span class="c1"># end is the world-coordinate location of a point traveling around the spiral centered between the two arms</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phase</span><span class="p">),</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phase</span><span class="p">)))</span>

            <span class="c1"># solve for the joint angles for the given endpoint</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endpointIK</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

            <span class="c1"># arbitrarily one solution as the target pose</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">s1</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Time: </span><span class="si">%f</span><span class="s2">  endpoint: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">set_marker</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># the other robot observes the first and tries to track the endpoint</span>
            <span class="n">end0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">world</span><span class="o">.</span><span class="n">dblpend_endpoint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">s1</span><span class="p">,</span> <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endpointIK</span><span class="p">(</span><span class="n">end0</span><span class="p">)</span>
            <span class="n">pose</span> <span class="o">=</span> <span class="n">s2</span>
            
        <span class="c1"># create a target state by extending the pose to include velocity</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pose</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># calculate position and velocity error as difference from reference state</span>
        <span class="n">qerr</span> <span class="o">=</span> <span class="n">target</span> <span class="o">-</span> <span class="n">state</span>

        <span class="c1"># apply PD control to reach the pose (no integral term)</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">tau</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">qerr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">+=</span> <span class="mi">1</span>        
        <span class="k">return</span>

<span class="c1">################################################################$</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">main</span><span class="p">(</span><span class="n">PendulumController</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&nbsp;&nbsp;<a href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/MQTT-Monitor.html">MQTT Monitor (PyQt5)</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a class="uplink" href="https://courses.ideate.cmu.edu/16-375/f2020/text/index.html">Contents</a>
        &nbsp;&nbsp;::&nbsp;&nbsp;
        <a href="https://courses.ideate.cmu.edu/16-375/f2020/text/code/exercise3.html">exercise3.py sample code</a>&nbsp;&nbsp;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        © Copyright 2020, Garth Zeglin. Licensed under <a class="reference external" href="http://creativecommons.org/licenses/by/4.0/">CC-BY-4.0</a>.
      Last updated on 2021-01-26.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.4.
    <a class="reference external" href="https://www.cmu.edu/legal/">University legal notice</a>.
    </div>
  
</body></html>